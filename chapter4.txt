This is chapter 4 from master branch.